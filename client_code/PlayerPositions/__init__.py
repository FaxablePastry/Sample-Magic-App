from anvil import *
import anvil.tables as tables
import anvil.tables.query as q
from anvil.tables import app_tables
from anvil.tables import app_tables
from ._anvil_designer import PlayerPositionsTemplate
class PlayerPositions(PlayerPositionsTemplate):
  def __init__(self, **properties):
    # Set Form properties and Data Bindings.
    self.init_components(**properties)
    self.form_show()

  def calculate_player_stats(self):
      player_stats = []
      # Retrieve all the records from the match_results table
      records = app_tables.match_results.search()
      # Count the games played and games won for each player
      player_stats_dict = {}
      for record in records:
          player = record['Player']
          player_position = record['PlayerPosition']
          player_count = record['PlayerCount']
  
          if player not in player_stats_dict:
              player_stats_dict[player] = {'games_played': 0, 'games_won': 0, 'points': 0}
  
          player_stats_dict[player]['games_played'] += 1
          if player_position == 1:
              player_stats_dict[player]['games_won'] += 1

          # Calculate points based on player position and the number of players#
          ## Change this to nested if elif statements
        
          if player_position == 1 and player_count == 4:
              player_stats_dict[player]['points'] += 6
          elif player_position == 2 and player_count == 4:
              player_stats_dict[player]['points'] += 4
          elif player_position == 3 and player_count == 4:
              player_stats_dict[player]['points'] += 2
          elif player_position == 4 and player_count == 4:
              player_stats_dict[player]['points'] += 1
          elif player_position == 1 and player_count == 3:
              player_stats_dict[player]['points'] += 5
          elif player_position == 2 and player_count == 3:
              player_stats_dict[player]['points'] += 3
          elif player_position == 3 and player_count == 3:
              player_stats_dict[player]['points'] += 1
  
      # Calculate the win rate and include winstreak information for each player
      for player, stats in player_stats_dict.items():
          games_played = stats['games_played']
          games_won = stats['games_won']
          win_rate = (games_won / games_played) * 100 if games_played > 0 else 0
          win_rate = round(win_rate, 2)
          player_points = stats['points']
  
          # Include winstreak and points information in the player statistics
          player_stat = {
              'Player': player,
              'GamesPlayed': games_played,
              'GamesWon': games_won,
              'WinRate': win_rate,
              'Points': player_points,
          }
          player_stats.append(player_stat)
      # Sort the player_stats list by Points and then by WinRate in descending order
      player_stats.sort(key=lambda x: (x['Points'], x['WinRate']), reverse=True)
      return player_stats


  def populate_player_positions_repeating_panel(self):
      # Retrieve all the records from the match_results table
      records = app_tables.match_results.search()
      player_stats = self.calculate_player_stats()
  
      # Create a dictionary to count player positions
      player_positions = {}
      for record in records:
          player = record['Player']
          position = record['PlayerPosition']
          
          if player not in player_positions:
              player_positions[player] = {1: 0, 2: 0, 3: 0, 4: 0}
          
          player_positions[player][position] += 1
      
      # Sort the player_positions dictionary by the count of first places (position 1)
      sorted_player_positions = dict(sorted(player_positions.items(), key=lambda item: item[1][1], reverse=True))
      
      # Create a list of dictionaries for the RepeatingPanel
      data = []
      player_points = {}

      for player_stat in player_stats:
            player = player_stat['Player']
            player_points[player] = player_stat['Points']

      for player, positions in sorted_player_positions.items():
            player_stat = next((item for item in player_stats if item['Player'] == player), None)
            row_data = {
                'column_1': player,
                'column_2': positions[1],
                'column_3': positions[2],
                'column_4': positions[3],
                'column_5': positions[4]
            }
            if player_stat:
                row_data['column_6'] = player_stat['Points']
            data.append(row_data)
      self.repeating_panel_1.items = data

  
  def form_show(self, **event_args):
      self.calculate_player_stats()
      self.populate_player_positions_repeating_panel()

  def button_1_click(self, **event_args):
      open_form('Home')

  def button_2_click(self, **event_args):
      open_form('AddMatch')

  def button_3_click(self, **event_args):
      open_form('AddCommander')

  def button_4_click(self, **event_args):
      open_form('CommanderStats')


  def button_5_click(self, **event_args):
      open_form('PlayerPositions')